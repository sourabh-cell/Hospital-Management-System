<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forgot Password</title>
    <link rel="stylesheet" th:href="@{/css/forgot_password.css}">
</head>
<body>
<div class="container">
    <h2>Forgot Password</h2>


    <!--  Success or Error Messages -->
    <p class="note" th:if="${message}" th:text="${message}"></p>
    <p class="error" th:if="${error}" th:text="${error}"></p>


<!-- Enter email id phase-->
    <form th:action="@{/request}" method="post" th:object="${forgotPasswordRequestDto}" th:if="${!otpPhase and !resetPhase}">
        <div class="form-group">
            <label for="email">Enter Registered Email ID</label>
            <input type="email" id="email" th:field="*{email}" placeholder="you@gmail.com" />
            <p class="error" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></p>
        </div>
        <button type="submit">Submit</button>
    </form>



    <!-- OTP phase-->
    <div class="otp-section" th:if="${otpPhase}">
    <form th:action="@{/validate}" method="post" th:object="${forgotPasswordRequestDto}">
        <input type="hidden" th:field="*{email}" />
        <div class="form-group">
            <label for="otp">Enter OTP</label>
            <input type="text" id="otp" th:field="*{otp}" placeholder="123456" />
            <p class="error" th:if="${#fields.hasErrors('otp')}" th:errors="*{otp}"></p>
        </div>
        <button type="submit">Submit OTP</button>
    </form>
        <!-- â± Countdown + Resend Button -->
        <div id="resendContainer">
            <p id="timerText">You can resend OTP in <span id="countdown">60</span> seconds</p>
            <form th:action="@{/resend-otp}" method="post" th:object="${forgotPasswordRequestDto}" style="display: none;" id="resendForm">
                <input type="hidden" th:field="*{email}" />
                <button type="submit" class="resend-btn">Resend OTP</button>
            </form>

        </div>

    </div>


    <!--Password reset phase-->

    <div class="reset-section" th:if="${resetPhase}">
    <form th:action="@{/reset}" method="post" th:object="${forgotPasswordRequestDto}">
        <input type="hidden" th:field="*{email}" />
        <!-- ðŸ”´ Global Errors -->
        <ul class="error-list" th:if="${#fields.hasGlobalErrors()}">
            <li th:each="err : ${#fields.globalErrors()}" th:text="${err}"></li>
        </ul>

        <div class="form-group">
            <label for="newPassword">New Password</label>
            <input type="password" id="newPassword" th:field="*{newPassword}" />
            <p class="error" th:if="${#fields.hasErrors('newPassword')}" th:errors="*{newPassword}"></p>
            <svg class="toggle-password" onclick="togglePassword('newPassword', this)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M12 5c-7.633 0-11 7-11 7s3.367 7 11 7 11-7 11-7-3.367-7-11-7zm0
              12c-2.761 0-5-2.239-5-5s2.239-5
              5-5 5 2.239 5 5-2.239 5-5 5zm0-8c-1.654
              0-3 1.346-3 3s1.346 3 3 3
              3-1.346 3-3-1.346-3-3-3z" />
            </svg>
        </div>
        <div class="form-group">
            <label for="confirmPassword">Confirm Password</label>
            <input type="password" id="confirmPassword" th:field="*{confirmPassword}" />
            <p class="error" th:if="${#fields.hasErrors('confirmPassword')}" th:errors="*{confirmPassword}"></p>
            <svg class="toggle-password" onclick="togglePassword('confirmPassword', this)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M12 5c-7.633 0-11 7-11 7s3.367 7 11 7 11-7
              11-7-3.367-7-11-7zm0 12c-2.761
              0-5-2.239-5-5s2.239-5 5-5 5
              2.239 5 5-2.239 5-5 5zm0-8c-1.654
              0-3 1.346-3 3s1.346 3 3 3
              3-1.346 3-3-1.346-3-3-3z" />
            </svg>
        </div>
        <button type="submit">Submit</button>
    </form>
    </div>


    <p class="note" th:if="${forgotPasswordRequestDto.email == null}">Enter your registered email address. Weâ€™ll send you a password reset link.</p>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Password toggle function

        function togglePassword(fieldId, icon) {
            const field = document.getElementById(fieldId);
            if (field.type === "password") {
                field.type = "text";
                icon.style.fill = "#0066ff";
            } else {
                field.type = "password";
                icon.style.fill = "#555";
            }
        }

        // Resend OTP timer logic
        let countdown = 60;
        let timer;

        const countdownSpan = document.getElementById("countdown");
        const timerText = document.getElementById("timerText");
        const resendForm = document.getElementById("resendForm");
        const resendButton = document.querySelector(".resend-btn");

        function startTimer() {
            countdown = 60;
            countdownSpan.textContent = countdown;
            timerText.style.display = "block";
            resendForm.style.display = "none";

            timer = setInterval(() => {
                countdown--;
                countdownSpan.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(timer);
                    timerText.style.display = "none";
                    resendForm.style.display = "block";
                    resendButton.disabled = false; // Enable button when visible
                }
            }, 1000);
        }

        // Start timer on page load
        startTimer();

        // Reset timer and disable button on resend click
        resendForm.addEventListener("submit", function () {
            resendButton.disabled = true; // Prevent double click
            setTimeout(() => {
                resendButton.disabled = false; // Re-enable after 3 seconds
            }, 6000);

            clearInterval(timer);
            startTimer();
        });
    });
</script>
</body>
</html>